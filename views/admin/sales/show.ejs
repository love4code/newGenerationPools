<%- include('../../partials/admin-header') %> <% if (typeof success !==
'undefined' && success.length > 0) { %>
<div class="alert alert-success alert-dismissible fade show">
  <%= success[0] %>
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<% } %> <% if (typeof error !== 'undefined' && error.length > 0) { %>
<div class="alert alert-danger alert-dismissible fade show">
  <%= error[0] %>
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<% } %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Sale #<%= sale._id.toString().slice(-8) %></h1>
  <div>
    <a href="/admin/sales/<%= sale._id %>/edit" class="btn btn-outline-primary"
      >Edit</a
    >
    <a href="/admin/sales" class="btn btn-secondary">Back to Sales</a>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card mb-3">
      <div class="card-header">Sale Details</div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <p>
              <strong>Customer:</strong>
              <% if (sale.customer) { %>
              <a href="/admin/customers/<%= sale.customer._id %>"
                ><%= sale.customer.name %></a
              >
              <% } else { %> Unknown <% } %>
            </p>
            <p>
              <strong>Sale Date:</strong> <%= new
              Date(sale.saleDate).toLocaleDateString() %>
            </p>
          </div>
          <div class="col-md-6">
            <p>
              <strong>Status:</strong>
              <span
                class="badge bg-<%= sale.status === 'paid' ? 'success' : sale.status === 'cancelled' ? 'danger' : sale.status === 'open' ? 'warning' : 'secondary' %>"
              >
                <%= sale.status %>
              </span>
            </p>
            <p>
              <strong>Payment Status:</strong>
              <span
                class="badge bg-<%= sale.paymentStatus === 'paid' ? 'success' : sale.paymentStatus === 'partial' ? 'warning' : 'secondary' %>"
              >
                <%= sale.paymentStatus %>
              </span>
            </p>
          </div>
        </div>
        <% if (sale.notes) { %>
        <p><strong>Notes:</strong><br /><%= sale.notes %></p>
        <% } %>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">Line Items</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Product</th>
                <th>SKU</th>
                <th>Unit Price</th>
                <th>Unit Cost</th>
                <th>Qty</th>
                <th>Taxable</th>
                <th>Subtotal</th>
                <th>Cost</th>
                <th>Tax</th>
                <th>Total</th>
                <th>Profit</th>
              </tr>
            </thead>
            <tbody>
              <% if (sale.lineItems && sale.lineItems.length > 0) { %> <%
              sale.lineItems.forEach(item => { %>
              <tr>
                <td><%= item.name %></td>
                <td><%= item.sku || '-' %></td>
                <td>$<%= item.unitPrice.toFixed(2) %></td>
                <td>$<%= (item.unitCost || 0).toFixed(2) %></td>
                <td><%= item.quantity %></td>
                <td><%= item.taxable ? 'Yes' : 'No' %></td>
                <td>$<%= item.lineSubtotal.toFixed(2) %></td>
                <td>$<%= (item.lineCost || 0).toFixed(2) %></td>
                <td>$<%= item.lineTax.toFixed(2) %></td>
                <td><strong>$<%= item.lineTotal.toFixed(2) %></strong></td>
                <td><strong class="text-success">$<%= ((item.lineTotal || 0) - (item.lineCost || 0)).toFixed(2) %></strong></td>
              </tr>
              <% }); %> <% } else { %>
              <tr>
                <td colspan="11" class="text-center text-muted">
                  No line items
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-header">Totals</div>
      <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
          <span>Subtotal:</span>
          <strong>$<%= sale.subtotal.toFixed(2) %></strong>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Tax (<%= (sale.taxRate * 100).toFixed(2) %>%):</span>
          <strong>$<%= sale.taxTotal.toFixed(2) %></strong>
        </div>
        <hr />
        <div class="d-flex justify-content-between mb-2">
          <span><strong>Total:</strong></span>
          <strong class="fs-5">$<%= sale.total.toFixed(2) %></strong>
        </div>
        <hr />
        <div class="d-flex justify-content-between mb-2">
          <span>Total Cost:</span>
          <strong>$<%= (sale.totalCost || 0).toFixed(2) %></strong>
        </div>
        <div class="d-flex justify-content-between">
          <span><strong>Total Profit:</strong></span>
          <strong class="fs-5 text-success">$<%= (sale.totalProfit || 0).toFixed(2) %></strong>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Sale Information</div>
      <div class="card-body">
        <p class="small text-muted">
          <strong>Created:</strong> <%= new
          Date(sale.createdAt).toLocaleString() %><br />
          <strong>Updated:</strong> <%= new
          Date(sale.updatedAt).toLocaleString() %>
        </p>
      </div>
    </div>
  </div>
</div>

<%- include('../../partials/admin-footer') %>
